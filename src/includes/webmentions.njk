{%- set mentions = webmentions.children | webmentionsByUrl(webmentionUrl) -%}
<div
  class="webmentions"
  id="webmentions"
  data-url="{{ webmentionUrl }}"
  data-last-fetched="{{ webmentions.lastFetched }}"
>
  <div data-render-root>
    {# --- INTERACTIONS (FACEPILE) --- #}
    {% set hasInteractions = false %}
    {% for webmention in mentions %}
      {%
        if webmention['wm-property'] == 'like-of' or webmention['wm-property'] == 'repost-of'
      %}
        {% set hasInteractions = true %}
      {% endif %}
    {% endfor %}

    {% if hasInteractions %}
      <div class="webmentions__interactions">
        <div class="webmentions__facepile">
          {% set zIndex = mentions|length %}
          {% for webmention in mentions %}
            {%
              if webmention['wm-property'] == 'like-of' or webmention['wm-property'] == 'repost-of'
            %}
              {# Inline z-index for correct left-on-top stacking #}
              <a
                class="webmentions__face-item"
                href="{{ webmention.author.url }}"
                target="_blank"
                rel="noopener noreferrer"
                title="{{ webmention.author.name }}"
                style="z-index: {{ zIndex }}"
              >
                {% if webmention.author.photo %}
                  <img
                    src="{{ webmention.author.photo }}"
                    alt="{{ webmention.author.name }}"
                    width="64"
                    height="64"
                    loading="lazy"
                    eleventy:ignore
                  />
                {% else %}
                  <svg
                    class="webmentions__face-icon"
                    role="img"
                    aria-hidden="true"
                    width="32"
                    height="32"
                    style="width:100%; height:100%; display:block; color: #888; background: #eee;"
                  >
                    <use
                      xmlns:xlink="http://www.w3.org/1999/xlink"
                      xlink:href="/assets/icons/icons.sprite.svg#svg-avatar"
                    >
                    </use>
                  </svg>
                {% endif %}

                {% if webmention['wm-property'] == 'like-of' %}
                  <span class="webmentions__face-action-icon">
                    {% icon "heart" %}
                  </span>
                {% elseif webmention['wm-property'] == 'repost-of' %}
                  <span class="webmentions__face-action-icon">
                    {% icon "repeat" %}
                  </span>
                {% endif %}
              </a>
            {% endif %}
            {% set zIndex = zIndex - 1 %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# --- COMMENTS LIST --- #}
    {# Count comments first #}
    {% set commentCount = 0 %}
    {% for webmention in mentions %}
      {%
        if webmention['wm-property'] != 'like-of' and webmention['wm-property'] != 'repost-of'
      %}
        {% set commentCount = commentCount + 1 %}
      {% endif %}
    {% endfor %}

    {% if commentCount > 0 %}
      <div class="webmentions__preview">
        <ol class="webmentions__list">
          {% set currentCount = 0 %}
          {% for webmention in mentions %}
            {%
              if webmention['wm-property'] != 'like-of' and webmention['wm-property'] != 'repost-of'
            %}
              {% if currentCount < 5 %}
                <li class="webmentions__item">
                  {% include 'webmention.njk' %}
                </li>
              {% endif %}
              {% set currentCount = currentCount + 1 %}
            {% endif %}
          {% endfor %}
        </ol>
      </div>

      {% if commentCount > 5 %}
        <div>
          <a class="webmentions__showall" href="#webmentions">
            {% icon "message" %} Show All Webmentions ({{ commentCount }})
          </a>

          <div class="webmentions__content">
            <ol class="webmentions__list">
              {% set currentCount = 0 %}
              {% for webmention in mentions %}
                {%
                  if webmention['wm-property'] != 'like-of' and webmention['wm-property'] != 'repost-of'
                %}
                  {% if currentCount >= 5 %}
                    <li class="webmentions__item">
                      {% include 'webmention.njk' %}
                    </li>
                  {% endif %}
                  {% set currentCount = currentCount + 1 %}
                {% endif %}
              {% endfor %}
            </ol>
          </div>
        </div>
      {% endif %}
    {% elseif not hasInteractions %}
      <p class="webmentions__empty">No webmentions yet.</p>
    {% endif %}
  </div>
</div>
