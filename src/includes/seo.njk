{%- set absolutePageUrl -%}{{ page.url | url | absoluteUrl(site.url) }}{%-
  endset
-%}
{%- set isPost = layout == 'post' -%}
{%- set isNote = layout == 'note' -%}

{%- if isPost -%}
  {%- set currentPage = collections.all | currentPage(page) -%}
  {%-
    set autoDescription = currentPage.templateContent | excerpt | safe | striptags
  -%}
{% endif %}

{# Page-Specific #}
<meta
  name="description"
  content="{{ description or autoDescription or site.description }}"
/>
{%- if image -%}
  {%- if '://' in image -%}
    {# Rule 0: External URLs are used as-is #}
    {%- set ogImagePath = image -%}
  {%- elif isNote -%}
    {# Rule 1: Notes always look in the Gallery #}
    {%- set ogImagePath = "src/assets/images/gallery/" + image -%}
  {%- elif isPost -%}
    {# Rule 2: Posts always use co-located images (Leaf Bundle) #}
    {# page.inputPath is relative to project root, e.g. ./src/posts/... #}
    {%- set ogImagePath = (page.inputPath | dirname) + "/" + image -%}
  {%- else -%}
    {# Rule 3: Regular Pages always look in the global Assets folder #}
    {%- set ogImagePath = "src/assets/images/" + image -%}
  {%- endif -%}

  {# Generate Optimized OG Image #}
  {% set generatedOgImage %}{% ogImage ogImagePath %}{% endset %}
  
  {% if generatedOgImage %}
    {% set pageImage = generatedOgImage | url | absoluteUrl(site.url) %}
  {% else %}
    {# Fallback if generation failed or file missing #}
    {%- if isNote -%}
       {%- set pageImage = ('/assets/images/gallery/' + image) | url | absoluteUrl(site.url) -%}
    {%- elif isPost -%}
       {%- set pageImage = absolutePageUrl + image -%}
    {%- else -%}
       {%- set pageImage = ('/assets/images/' + image) | url | absoluteUrl(site.url) -%}
    {%- endif -%}
  {% endif %}

  <meta name="image" content="{{ pageImage }}" />
{%- endif -%}

<meta property="og:title" content="{{ title or site.title }}" />
<meta
  property="og:description"
  content="{{ description or autoDescription or site.description }}"
/>
<meta property="og:url" content="{{ absolutePageUrl }}" />
<meta
  property="og:image"
  content="{%- if image -%}{{ pageImage }}{%- else -%}{{ author.avatar | url | absoluteUrl(site.url) }}{%- endif -%}"
/>

{%- if isPost -%}
  <meta property="og:type" content="article" />
  <meta
    property="article:published_time"
    content="{{ page.date | dateToISO }}"
  />
{%- endif -%}

{# General #}
<meta name="author" content="{{ author.name }}" />
<meta property="og:site_name" content="{{ site.title }}" />
<meta property="og:locale" content="{{ site.locale }}" />
<meta name="fediverse:creator" content="{{ author.social.mastodon.name }}" />

<link rel="canonical" href="{{ canonicalUrl or absolutePageUrl }}" />

{# JSON LD #}
<script type="application/ld+json">
{
  "name": "{{ author.name }}",
  "description": "{{ site.description }}",
  "author": {
    "@type": "Person",
    "name": "{{ author.name }}"
  },
  "@type": "WebSite",
  "url": "{{ site.url }}",
  "headline": "{{ site.title }}",
  "sameAs": ["https://github.com/{{ author.username }}"],
  "@context": "http://schema.org"
}
</script>
